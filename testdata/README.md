# Testdata Directory Structure

This directory contains canonical test data and generated code for validating the SDP code generator and wire format compatibility.

## Directory Layout

```
testdata/
├── schemas/        # .sdp schema files (SOURCE OF TRUTH)
├── data/           # .json test data (benchmark inputs)
├── binaries/       # .sdpb reference wire format (validation)
├── go/             # Generated Go code for all schemas
├── cpp/            # Generated C++ code for all schemas
└── rust/           # Generated Rust code for all schemas
```

## Canonical Data Files

### schemas/*.sdp - Schema Definitions
**Purpose:** Source code for SDP schemas  
**Generated by:** Manual/test creation  
**Used for:** Parsing, validation, code generation

Examples:
- `schemas/primitives.sdp` - All primitive types
- `schemas/arrays.sdp` - Array types
- `schemas/nested.sdp` - Nested structs
- `schemas/optional.sdp` - Optional fields
- `schemas/audiounit.sdp` - Real-world example (1,759 parameters)

### data/*.json - Test Data
**Purpose:** Readable test inputs for encoding benchmarks  
**Generated by:** Manual test creation  
**Used for:** Populating structs before encoding, benchmark inputs

Examples:
- `data/primitives.json` - 12 test cases with edge values
- `data/arrays.json` - Array data (primitives + structs)
- `data/nested.json` - 100 nested struct test cases
- `data/optional.json` - 50 configs with optional fields present/absent
- `data/plugins.json` - 62 AudioUnit plugins (real data)

### binaries/*.sdpb - Reference Wire Format
**Purpose:** Byte-for-byte reference for wire format validation  
**Generated by:** Go encoder (verified correct)  
**Used for:** Cross-language compatibility testing

These files prove that Go encoder → bytes → C++ decoder works identically to C++ encoder → bytes → Go decoder.

## Generated Code Directories

### go/, cpp/, rust/ - Language-Specific Generated Code
**Purpose:** Code generated from schemas for testing  
**Generated by:** `sdp-gen` command  
**Used for:** Integration tests, wire format validation, benchmarks

Each language directory contains subdirectories matching schema names:
```
go/
├── primitives/     # types.go, encode.go, decode.go, errors.go
├── arrays/
├── nested/
├── optional/
└── audiounit/
```

## Data Flow

```
.sdp schema → sdp-gen → Generated code
                             ↓
.json data → Populate struct → Encode → .sdpb binary
                                            ↓
                                         Decode → Verify match
```

## Regenerating Test Code

```bash
# Regenerate all Go code
for schema in testdata/schemas/*.sdp; do
    name=$(basename $schema .sdp)
    ./sdp-gen -schema $schema -output testdata/go/$name -lang go
done

# Regenerate all C++ code
for schema in testdata/schemas/*.sdp; do
    name=$(basename $schema .sdp)
    ./sdp-gen -schema $schema -output testdata/cpp/$name -lang cpp
done

# Regenerate all Rust code
for schema in testdata/schemas/*.sdp; do
    name=$(basename $schema .sdp)
    ./sdp-gen -schema $schema -output testdata/rust/$name -lang rust
done
```

## Testing Strategy

### Go Tests (`integration_test.go`)
✅ Schema parsing correctness  
✅ Validation (circular refs, reserved keywords)  
✅ Go code generation compiles  
✅ Wire format matches `.sdpb` files  
✅ Roundtrip encode/decode  

❌ NO cross-language testing (use shell scripts)  
❌ NO benchmarking other languages (use Make targets)

### Cross-Language Testing (Shell Scripts)
Use `tests/verify_wire_format.sh`:
1. Go encodes JSON → binary
2. C++ decodes binary → verify
3. C++ encodes JSON → binary
4. Go decodes binary → verify

### Benchmarking (Make Targets)
Use `benchmarks/compare.sh`:
1. Measure Go encode/decode performance
2. Measure C++ encode/decode performance
3. Compare and report

## Why This Structure?

✅ **Clear separation** - Canonical files vs generated code  
✅ **Language-agnostic** - Easy to add new languages  
✅ **Discoverable** - `data/` obviously contains test inputs  
✅ **Composable** - Scripts can iterate `schemas/*.sdp`  
✅ **Maintainable** - No deeply nested directories  
✅ **Testable** - Go tests stay in Go scope

## Canonical vs Generated

| Type | Canonical | Generated | Git Tracked |
|------|-----------|-----------|-------------|
| `.sdp` schemas | ✅ | ❌ | ✅ |
| `.json` data | ✅ | ❌ | ✅ |
| `.sdpb` binaries | ✅ | ❌ | ✅ |
| Go code | ❌ | ✅ | ❌ (gitignored) |
| C++ code | ❌ | ✅ | ❌ (gitignored) |
| Rust code | ❌ | ✅ | ❌ (gitignored) |

Generated code is rebuilt by `TestMain()` before running Go tests.

## Schema Descriptions

| Schema | Description | Complexity |
|--------|-------------|------------|
| `primitives` | All 12 primitive types | Simple |
| `arrays` | Arrays of primitives + structs | Medium |
| `nested` | 3-level struct nesting | Medium |
| `optional` | Optional struct fields | Medium |
| `audiounit` | Real-world plugin data (1,759 params) | Complex |
| `complex` | Deprecated, use `audiounit` | Legacy |

## Adding New Test Schemas

1. Create `schemas/myschema.sdp`
2. Create `data/myschema.json` (optional, for benchmarks)
3. Generate code: `./sdp-gen -schema testdata/schemas/myschema.sdp -output testdata/go/myschema -lang go`
4. Run tests: `go test ./...`

The `TestMain()` function will auto-regenerate code before running tests.
