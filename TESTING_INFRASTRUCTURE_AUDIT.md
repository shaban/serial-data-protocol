# Testing Infrastructure Audit - Problems & Solutions

**Date:** October 22, 2025  
**Status:** üî¥ Critical Issues Found

---

## üö® Problems Identified

### 1. **Manual Tampering with Generated Code**

**Problem:** Generated code directories (`testdata/{lang}/{schema}/`) contain manually created files that should NOT be there.

**Examples found:**
- `testdata/rust/audiounit/benches/audiounit_benchmark.rs` - Manually created benchmark
- `testdata/rust/audiounit/Cargo.toml` - Manually edited (package name, removed example, added bench config)
- `testdata/rust/messagemode/benches/benchmarks.rs` - Manually created
- `testdata/rust/messagemode/tests/crosslang_test.rs` - Manually created

**Why this is bad:**
- Running `sdp-gen` again will DELETE or OVERWRITE these files
- No reproducibility - manual edits not tracked in generation logic
- Violates "Code generated by sdp-gen. DO NOT EDIT" directive
- Makes CI/CD impossible (can't regenerate from scratch)

---

### 2. **Benchmarks in Wrong Location**

**Problem:** Benchmarks are scattered in multiple places with no single source of truth:

```
benchmarks/                           ‚Üê Official location (C++, Go)
  cpp/messagemode/bench_audiounit.cpp ‚Üê Uses testdata/cpp/audiounit/*
  go/comparison_test.go               ‚Üê Go benchmarks

testdata/rust/audiounit/benches/      ‚Üê WRONG! Inside generated code
testdata/rust/messagemode/benches/    ‚Üê WRONG! Inside generated code
```

**Why this is bad:**
- Inconsistent structure across languages
- Benchmarks get deleted when regenerating code
- No Make orchestration for Rust benchmarks

---

### 3. **No Unified Make Orchestration**

**Problem:** Each language has different test/benchmark workflows:

- **Go:** `go test ./...` (works, but not Make-driven for benchmarks)
- **C++:** Make-driven (`benchmarks/Makefile`) ‚úÖ GOOD
- **Rust:** Manual `cargo test`, `cargo bench` (no Make integration) ‚ùå

**Missing:**
- Single command to regenerate ALL code from schemas
- Single command to run ALL tests
- Single command to run ALL benchmarks
- Verification that generated code hasn't been tampered with

---

### 4. **Duplicate/Inconsistent Test Data**

**Problem:** Sample data and binary files scattered in multiple places:

```
testdata/data/*.json              ‚Üê Official sample data ‚úÖ
testdata/binaries/*.sdpb          ‚Üê Official binary reference files ‚úÖ
testdata/schemas/*.sdp            ‚Üê Official schemas ‚úÖ

BUT ALSO:
testdata/audiounit.sdpb           ‚Üê Duplicate? (root level)
testdata/*.json                   ‚Üê Duplicate? (root level)
benchmarks/audiounit.proto        ‚Üê For protobuf comparison
benchmarks/audiounit.fbs          ‚Üê For flatbuffers comparison
```

**Why this is bad:**
- Not clear which files are authoritative
- Risk of using outdated data in tests
- Hard to maintain consistency

---

### 5. **Path Resolution Issues**

**Problem:** Hardcoded relative paths that break depending on execution context:

```rust
// In testdata/rust/audiounit/benches/audiounit_benchmark.rs
let data = fs::read("../../binaries/audiounit.sdpb")?;
```

This path is FRAGILE:
- Works if running from `testdata/rust/audiounit/`
- Breaks if running from project root
- Breaks if running from `benchmarks/`

**Should use:** Make variables like `$(PROJECT_ROOT)/testdata/binaries/audiounit.sdpb`

---

## ‚úÖ Proposed Solutions

### Solution 1: Separate Generated Code from Tests/Benchmarks

**Structure:**
```
testdata/
  schemas/          ‚Üê Official schemas (.sdp files)
  data/             ‚Üê Official sample data (.json files)
  binaries/         ‚Üê Official binary reference files (.sdpb files)
  generated/        ‚Üê Generated code ONLY (clean sdp-gen output)
    go/{schema}/
    cpp/{schema}/
    rust/{schema}/
    swift/{schema}/

benchmarks/         ‚Üê All benchmarks here (not in generated/)
  go/
    bytemode/
    messagemode/
  cpp/
    bytemode/
    messagemode/
  rust/
    bytemode/
    messagemode/      ‚Üê Move audiounit_benchmark.rs HERE
  Makefile          ‚Üê Orchestrates everything

tests/              ‚Üê Integration tests (not in generated/)
  crosslang/
    go/
    cpp/
    rust/
  Makefile          ‚Üê Orchestrates cross-language tests
```

**Benefits:**
- Generated code can be deleted and regenerated safely
- Tests/benchmarks are permanent, version-controlled
- Clear separation of concerns

---

### Solution 2: Make-Orchestrated Code Generation

**Root Makefile:**
```makefile
PROJECT_ROOT := $(abspath .)
SCHEMAS_DIR := $(PROJECT_ROOT)/testdata/schemas
DATA_DIR := $(PROJECT_ROOT)/testdata/data
BINARIES_DIR := $(PROJECT_ROOT)/testdata/binaries
GENERATED_DIR := $(PROJECT_ROOT)/testdata/generated
SDP_GEN := $(PROJECT_ROOT)/sdp-gen

# Generate all code from schemas
.PHONY: generate
generate: $(SDP_GEN)
	@echo "Generating code from schemas..."
	@rm -rf $(GENERATED_DIR)  # Clean slate
	@$(SDP_GEN) -schema $(SCHEMAS_DIR)/primitives.sdp -output $(GENERATED_DIR)/go/primitives -lang go
	@$(SDP_GEN) -schema $(SCHEMAS_DIR)/primitives.sdp -output $(GENERATED_DIR)/cpp/primitives -lang cpp
	@$(SDP_GEN) -schema $(SCHEMAS_DIR)/primitives.sdp -output $(GENERATED_DIR)/rust/primitives -lang rust
	# ... repeat for all schemas
	@echo "‚úì Code generation complete"

# Verify generated code hasn't been tampered with
.PHONY: verify-generated
verify-generated: generate
	@echo "Verifying generated code matches clean sdp-gen output..."
	@git diff --exit-code $(GENERATED_DIR) || (echo "ERROR: Generated code has been manually edited!" && exit 1)

# Run all tests
.PHONY: test
test: generate
	@echo "Running tests..."
	@cd tests && $(MAKE) test-all

# Run all benchmarks
.PHONY: bench
bench: generate
	@echo "Running benchmarks..."
	@cd benchmarks && $(MAKE) bench-all
```

---

### Solution 3: Use Make Variables for Paths

**benchmarks/rust/messagemode/Makefile:**
```makefile
# Inherit from parent Makefile
include ../../Makefile.vars

AUDIOUNIT_SCHEMA := $(SCHEMAS_DIR)/audiounit.sdp
AUDIOUNIT_DATA := $(BINARIES_DIR)/audiounit.sdpb
GENERATED_CODE := $(GENERATED_DIR)/rust/audiounit

.PHONY: bench-audiounit
bench-audiounit: audiounit_benchmark
	@AUDIOUNIT_DATA=$(AUDIOUNIT_DATA) ./audiounit_benchmark

audiounit_benchmark: audiounit_benchmark.rs $(GENERATED_CODE)
	@cargo build --release --manifest-path=$(GENERATED_CODE)/Cargo.toml
	@rustc --edition 2021 -O \
		--extern sdp_audiounit=$(GENERATED_CODE)/target/release/libsdp_audiounit.rlib \
		-L $(GENERATED_CODE)/target/release/deps \
		-o $@ $<
```

---

### Solution 4: Official Test Data Registry

**testdata/MANIFEST.md:**
```markdown
# Official Test Data Manifest

## Schemas (Single Source of Truth)
- `schemas/primitives.sdp` - Basic types (u8, u16, u32, u64, i8, i16, i32, i64, f32, f64, string)
- `schemas/arrays.sdp` - Array types
- `schemas/nested.sdp` - Nested structs
- `schemas/optional.sdp` - Optional fields
- `schemas/audiounit.sdp` - Real-world example (62 plugins, 1,759 parameters)
- `schemas/message_test.sdp` - Message mode testing (Point, Rectangle)

## Sample Data (Single Source of Truth)
- `data/primitives.json` - Corresponds to primitives.sdp
- `data/arrays.json` - Corresponds to arrays.sdp
- `data/nested.json` - Corresponds to nested.sdp
- `data/optional.json` - Corresponds to optional.sdp
- `data/plugins.json` - Corresponds to audiounit.sdp (110KB real data)

## Binary Reference Files (Generated, Version-Controlled)
- `binaries/primitives.sdpb` - Generated by: `sdp-encode -schema primitives.sdp -data primitives.json`
- `binaries/arrays_primitives.sdpb` - Primitive array test case
- `binaries/arrays_structs.sdpb` - Struct array test case
- `binaries/nested.sdpb` - Nested struct test case
- `binaries/optional.sdpb` - Optional field test case
- `binaries/audiounit.sdpb` - AudioUnit real-world data
- `binaries/message_point.sdpb` - Message mode Point (Go-generated)
- `binaries/message_point_cpp.sdpb` - Message mode Point (C++-generated)
- `binaries/message_rectangle.sdpb` - Message mode Rectangle (Go-generated)
- `binaries/message_rectangle_cpp.sdpb` - Message mode Rectangle (C++-generated)

## Rules
1. **NEVER manually edit .sdpb files** - Always regenerate from .json using sdp-encode
2. **NEVER duplicate sample data** - Use official data/*.json files
3. **NEVER hardcode paths** - Use Make variables ($(DATA_DIR), $(BINARIES_DIR))
4. **Version control .sdpb files** - They are ground truth for cross-language testing
```

---

## üéØ Action Plan

### Phase 1: Restructure (High Priority)
- [ ] Create `testdata/generated/` directory
- [ ] Move all generated code to `testdata/generated/{lang}/{schema}/`
- [ ] Move `testdata/rust/*/benches/*.rs` to `benchmarks/rust/messagemode/`
- [ ] Move `testdata/rust/*/tests/*.rs` to `tests/crosslang/rust/`
- [ ] Update all imports/paths in moved files

### Phase 2: Make Infrastructure (High Priority)
- [ ] Create root `Makefile` with `generate`, `test`, `bench` targets
- [ ] Create `Makefile.vars` with PROJECT_ROOT, SCHEMAS_DIR, etc.
- [ ] Update `benchmarks/Makefile` to include Rust
- [ ] Create `tests/Makefile` for cross-language tests
- [ ] Add `verify-generated` target to catch tampering

### Phase 3: Documentation (Medium Priority)
- [ ] Create `testdata/MANIFEST.md` documenting official test data
- [ ] Update `TESTING_STRATEGY.md` with new structure
- [ ] Update `README.md` with new build commands
- [ ] Add CI/CD examples using Make targets

### Phase 4: Cleanup (Low Priority)
- [ ] Remove duplicate files (testdata root vs testdata/data)
- [ ] Consolidate benchmark comparison files
- [ ] Archive old testing approaches

---

## üìù Impact Assessment

**What breaks:**
- ‚ùå Current Rust benchmarks (path changes)
- ‚ùå Current Rust tests (path changes)
- ‚ùå Any manual workflow not using Make

**What improves:**
- ‚úÖ Can regenerate all code with `make generate`
- ‚úÖ Can verify no tampering with `make verify-generated`
- ‚úÖ Single command for all tests: `make test`
- ‚úÖ Single command for all benchmarks: `make bench`
- ‚úÖ Clear separation: generated vs permanent files
- ‚úÖ CI/CD ready
- ‚úÖ Reproducible builds

---

## üîç Questions for User

1. **Approve restructure?** Move generated code to `testdata/generated/`?
2. **Break current paths?** This will require updating benchmarks/tests
3. **Commit strategy?** One big commit or incremental migration?
4. **Priority?** Should we fix this before continuing with new features?

---

## üìö References

- `CONSTITUTION.md` - Single source of truth principle
- `TESTING_STRATEGY.md` - Current testing approach (needs update)
- `MODERNIZATION_SUMMARY.md` - Related infrastructure improvements
- `benchmarks/Makefile` - Current Make orchestration (C++ only)
